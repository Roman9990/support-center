import asyncio
import sqlite3
import json
import base64
import os

from aiogram import Bot, Dispatcher, F
from aiogram.client.default import DefaultBotProperties
from aiogram.filters import Command
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, WebAppInfo
from aiogram.utils.keyboard import InlineKeyboardBuilder

API_TOKEN = "8489240049:AAHtyPfco7jlIrydjE6ZWU64y3ABoSBKmBY"
OWNER_ID = 5518423575
DB_PATH = "bot.db"
MINI_APP_URL = "https://roman9990.github.io/support-center/"

bot = Bot(API_TOKEN, default=DefaultBotProperties(parse_mode="HTML"))
dp = Dispatcher()

def get_db():
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    if os.path.exists(DB_PATH):
        os.remove(DB_PATH)
    with get_db() as conn:
        conn.execute("CREATE TABLE users (user_id INTEGER PRIMARY KEY, username TEXT, role TEXT DEFAULT 'user')")
        conn.execute("CREATE TABLE admin_tags (admin_id INTEGER PRIMARY KEY, tag TEXT UNIQUE)")
        conn.execute("CREATE TABLE user_tags (user_id INTEGER PRIMARY KEY, tag TEXT)")
        conn.execute("CREATE TABLE active_chats (user_id INTEGER PRIMARY KEY, admin_id INTEGER)")
        conn.execute("INSERT OR IGNORE INTO users(user_id,username,role) VALUES(?,?,?)", (OWNER_ID,"OWNER","owner"))

def add_user(uid, username=None, role="user"):
    with get_db() as conn:
        conn.execute("INSERT OR REPLACE INTO users(user_id,username,role) VALUES(?,?,?)", (uid, username, role))

def get_user_role(uid):
    with get_db() as conn:
        r = conn.execute("SELECT role FROM users WHERE user_id=?", (uid,)).fetchone()
        return r["role"] if r else "user"

def is_owner(uid): return uid==OWNER_ID
def is_admin(uid): return get_user_role(uid) in ["owner","admin","moderator","support"]

def get_user_tag(uid):
    with get_db() as conn:
        r = conn.execute("SELECT tag FROM user_tags WHERE user_id=?", (uid,)).fetchone()
        return r["tag"] if r else f"user{uid}"

def get_admin_tag(aid):
    with get_db() as conn:
        r = conn.execute("SELECT tag FROM admin_tags WHERE admin_id=?", (aid,)).fetchone()
        return r["tag"] if r else f"admin{aid}"

def get_admins():
    with get_db() as conn:
        rows = conn.execute("""
            SELECT u.user_id,u.role,COALESCE(at.tag,'admin'||u.user_id) AS tag
            FROM users u LEFT JOIN admin_tags at ON at.admin_id=u.user_id
            WHERE u.role IN('owner','admin','moderator','support')
            ORDER BY u.user_id
        """).fetchall()
    cols=["#ff6b35","#f7931e","#c44569","#546de5","#ff9ff3","#54a0ff"]
    admins=[]
    for i,r in enumerate(rows):
        admins.append({
            "id":r["user_id"],
            "tag":r["tag"],
            "status":"online" if i%2==0 else "offline",
            "accent_color":cols[i%len(cols)],
            "role":r["role"]
        })
    return admins

def create_miniapp_url(uid):
    admins=get_admins()
    p={"admins":admins,"user":{"id":uid,"tag":get_user_tag(uid)},"config":{"show_tags":True}}
    b=base64.b64encode(json.dumps(p,ensure_ascii=False).encode()).decode()
    return f"{MINI_APP_URL}?data={b}"

def main_menu(uid):
    kb=InlineKeyboardBuilder()
    kb.button(text="üöÄ –¶–µ–Ω—Ç—Ä –ü–æ–¥–¥–µ—Ä–∂–∫–∏", web_app=WebAppInfo(url=create_miniapp_url(uid)))
    kb.button(text="üë§ –ü—Ä–æ—Ñ–∏–ª—å",callback_data="profile")
    kb.button(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å",callback_data="refresh")
    kb.adjust(1,2)
    return kb.as_markup()

@dp.message(Command("start"))
async def cmd_start(m:Message):
    add_user(m.from_user.id,m.from_user.username)
    cnt=len(get_admins())
    await m.answer(f"üöÄ –ü—Ä–∏–≤–µ—Ç! –ê–¥–º–∏–Ω–æ–≤: {cnt}",reply_markup=main_menu(m.from_user.id))

@dp.message(Command("add_admin"))
async def cmd_add_admin(m:Message):
    if not is_owner(m.from_user.id):
        await m.answer("‚ùå –ù–µ—Ç –ø—Ä–∞–≤",reply_markup=main_menu(m.from_user.id));return
    parts=m.text.split()
    if len(parts)<3:
        await m.answer("üìù /add_admin USER_ID –¢–ï–ì");return
    try:
        uid=int(parts[1]); tag=parts[2]
        with get_db() as c:
            c.execute("INSERT OR REPLACE INTO users(user_id,role) VALUES(?,?)",(uid,"support"))
            c.execute("INSERT OR REPLACE INTO admin_tags(admin_id,tag) VALUES(?,?)",(uid,tag))
            c.execute("INSERT OR REPLACE INTO user_tags(user_id,tag) VALUES(?,?,?)",(uid,tag))
        await m.answer(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω #{tag}",reply_markup=main_menu(m.from_user.id))
    except Exception as e:
        await m.answer(f"‚ùå {e}")

@dp.message(Command("list_admins"))
async def cmd_list(m:Message):
    a=get_admins()
    if not a: await m.answer("üìã –ù–µ—Ç –∞–¥–º–∏–Ω–æ–≤",reply_markup=main_menu(m.from_user.id));return
    txt="üöÄ –ê–¥–º–∏–Ω—ã:\n"
    for x in a: txt+=f"‚Ä¢ #{x['tag']} (ID {x['id']})\n"
    await m.answer(txt,reply_markup=main_menu(m.from_user.id))

@dp.callback_query(F.data=="refresh")
async def cb_ref(c:CallbackQuery):
    await c.message.edit_text("üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–æ",reply_markup=main_menu(c.from_user.id)); await c.answer()

@dp.callback_query(F.data=="profile")
async def cb_pr(c:CallbackQuery):
    u=c.from_user.id; await c.message.edit_text(
        f"üë§ ID: {u}\n–¢–µ–≥: #{get_user_tag(u)}\n–†–æ–ª—å: {get_user_role(u)}",
        reply_markup=main_menu(u)); await c.answer()

@dp.message(F.web_app_data)
async def handle_webapp(m:Message):
    d=json.loads(m.web_app_data.data)
    if d.get("action")=="select_admin":
        aid=d["admin_id"]; tag=d["admin_tag"]
        # notify admin
        kb=InlineKeyboardBuilder()
        kb.button(text="‚úÖ –ü—Ä–∏–Ω—è—Ç—å",callback_data=f"accept_{m.from_user.id}")
        kb.button(text="‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å",callback_data=f"decline_{m.from_user.id}")
        await bot.send_message(aid,
            f"üîî –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç #{get_user_tag(m.from_user.id)} (ID {m.from_user.id})",
            reply_markup=kb.as_markup())
        await m.answer("‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")

@dp.callback_query(F.data.startswith("accept_"))
async def cb_accept(c:CallbackQuery):
    uid=int(c.data.split("_")[1]); aid=c.from_user.id; tag=get_admin_tag(aid)
    kb=InlineKeyboardBuilder()
    kb.button(text="‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å",callback_data=f"chat_{aid}")
    kb.button(text="üîö –ó–∞–≤–µ—Ä—à–∏—Ç—å",callback_data=f"end_{aid}")
    await bot.send_message(uid,f"üåÖ –í–∞—Å —É–Ω–µ—Å –≤ –∑–∞–∫–∞—Ç —Ç–µ–ª–µ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å #{tag}",reply_markup=kb.as_markup())
    await c.answer()

@dp.callback_query(F.data.startswith("decline_"))
async def cb_decline(c:CallbackQuery):
    uid=int(c.data.split("_")[1]); tag=get_admin_tag(c.from_user.id)
    await bot.send_message(uid,f"üíî –¢–µ–ª–µ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å #{tag} –æ—Ç–∫–∞–∑–∞–ª—Å—è",reply_markup=main_menu(uid))
    await c.answer()

@dp.callback_query(F.data.startswith("chat_"))
async def cb_chat(c:CallbackQuery):
    await c.message.answer("‚úâÔ∏è –ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:")
    await c.answer()

@dp.callback_query(F.data.startswith("end_"))
async def cb_end(c:CallbackQuery):
    aid=int(c.data.split("_")[1]); uid=c.from_user.id; tag=get_admin_tag(aid)
    with get_db() as conn: conn.execute("DELETE FROM active_chats WHERE user_id=?", (uid,))
    kb=InlineKeyboardBuilder()
    kb.button("üöÄ –ù–æ–≤—ã–π",callback_data="refresh")
    kb.button("üò¥ –û—Ç–¥–æ—Ö–Ω—É—Ç—å",callback_data="profile")
    await c.message.answer(f"üåå –í—ã –∫–∏–Ω—É–ª–∏ –≤ –Ω–µ–±–µ—Å–∞ —Ç–µ–ª–µ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—è #{tag}",reply_markup=kb.as_markup())
    await c.answer()

async def main():
    init_db()
    await dp.start_polling(bot)

if __name__=="__main__":
    asyncio.run(main())
